pipeline {
    agent any

    parameters {
        choice(name: 'ENV', choices: ['dev', 'staging', 'prod'], description: 'Wähle die Umgebung')
        string(name: 'MESSAGE', defaultValue: '', description: 'Gib eine Nachricht für das Deployment an')
    }

    stages {
        stage('Deploy') {
            steps {
                script {
                    def message = params.MESSAGE ?: "Kein Kommentar zum Deployment angegeben."
                    if (params.ENV == 'prod' && currentBuild.rawBuild.getCause(hudson.model.Cause$UserIdCause) == null) {
                        echo "Achtung! Deployment auf PROD darf nur manuell erfolgen!"
                        error("Deployment auf PROD abgebrochen.")
                    } else {
                        if (params.ENV == 'dev') {
                            echo "Deployment in DEV läuft..."
                        } else if (params.ENV == 'staging') {
                            echo "Deployment in STAGING läuft..."
                        } else if (params.ENV == 'prod') {
                            echo "Deployment in PROD läuft..."
                        }
                        echo "Nachricht des Nutzers: ${message}"
                    }
                }
            }
        }
        stage('Verification') {
            steps {
                echo "Deployment erfolgreich für ${params.ENV}"
            }
        }
    }
}